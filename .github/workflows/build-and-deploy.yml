name: Build & Deploy
on: 
  push:
    branches:
      - master
jobs:
  deploy:
      runs-on: ubuntu-latest
      env: 
        token: ${{ secrets.LINKS_TOKEN }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
      steps:
        - uses: actions/checkout@v3 
#         - uses: actions/setup-node@v3
#           with:
#             node-version: 18
#         - name: Install
#           run: npm ci
#         - name: Build
#           run: npm run build
#         - uses: webfactory/ssh-agent@v0.6.0
#           with:
#             ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        - name: Deploy
          run: | 
            link=`curl -s -H "Authorization: Bearer $token" -H "Accept: application/vnd.github.v3.raw" https://api.github.com/repos/quicknotes-project/links/contents/link.txt`
            proto=$(echo $link | grep :// | sed -e's,^\(.*://\).*,\1,g')
            url=$(echo ${link/$proto/})
            user=$(echo $url | grep @ | cut -d@ -f1)
            hostport=$(echo ${url/$user@/} | cut -d/ -f1)
            host=$(echo $hostport | sed -e 's,:.*,,g')
            port=$(echo $hostport | sed -e 's,^.*:,:,g' -e 's,.*:\([0-9]*\).*,\1,g' -e 's,[^0-9],,g')
            mkdir -p ~/.ssh
            echo $key > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan $host >> ~/.ssh/known_hosts
            ssh -i ~/.ssh/id_rsa -o UserKnownHostsFile=~/.ssh/known_hosts -p $port pi@$host 'touch ~/test' 
